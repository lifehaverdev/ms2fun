# Local Development System Design
**Date:** 2026-01-08
**Status:** Approved
**Purpose:** Enable local development with Anvil mainnet fork, real contract deployment, and seeded test data

---

## Overview

This system integrates the `ms2fun-contracts` Foundry repository as a git submodule, providing a complete local blockchain development environment. Developers can interact with real contracts on a local Anvil fork with pre-seeded test data demonstrating all protocol features.

**Key Goals:**
- Version-locked contract integration via git submodule
- One-command chain setup with deployment and seeding
- Automatic network detection (local Anvil vs mainnet)
- Representative test data showing all instance types and states
- Real wallet integration via MetaMask on local fork

---

## Repository Structure

```
ms2fun/
â”œâ”€â”€ contracts/                    # Git submodule â†’ ms2fun-contracts
â”‚   â”œâ”€â”€ src/                     # Solidity contracts
â”‚   â”œâ”€â”€ script/                  # Foundry deployment scripts
â”‚   â”‚   â””â”€â”€ DeployLocal.s.sol   # NEW: Custom local deployment + seeding
â”‚   â”œâ”€â”€ out/                     # Forge build artifacts (ABIs here)
â”‚   â””â”€â”€ foundry.toml
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ local-chain/
â”‚       â”œâ”€â”€ start-chain.sh       # Kill existing Anvil, start fresh fork
â”‚       â”œâ”€â”€ deploy-and-seed.sh   # Deploy contracts + seed test data
â”‚       â””â”€â”€ setup.sh             # One-time: install submodule, build contracts
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ contracts.local.json     # AUTO-GENERATED by deploy script
â”‚   â”‚   â”œâ”€â”€ contracts.mainnet.json   # Hand-maintained mainnet addresses
â”‚   â”‚   â””â”€â”€ network.js               # Network detection logic
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ abiLoader.js             # UPDATED: Hybrid ABI loading
â”‚
â”œâ”€â”€ package.json                 # UPDATED: New npm scripts
â”œâ”€â”€ .gitmodules                  # Submodule configuration
â””â”€â”€ docs/
    â””â”€â”€ plans/
        â””â”€â”€ 2026-01-08-local-development-system-design.md  # This file
```

**Key Points:**
- Submodule locks frontend to specific contract commit hash
- `contracts/out/` contains fresh ABIs after Forge build
- Local deployment script (`DeployLocal.s.sol`) creates custom seed data
- Config files auto-generated, never manually edited
- Scripts handle all git submodule commands

---

## Developer Workflow

### Initial Setup (One-Time)

```bash
# Clone with submodules (new team members)
git clone --recursive <ms2fun-repo-url>

# Or if already cloned (existing team members)
npm run setup:local
```

**What `setup:local` does:**
1. Initializes git submodule: `git submodule update --init --recursive`
2. Builds contracts: `cd contracts && forge build`
3. Verifies Foundry is installed
4. Creates initial config files

### Daily Development Workflow

**Terminal 1 - Start Local Chain:**
```bash
npm run chain:start
```

**What happens:**
1. Kills any process on port 8545 (`lsof -ti:8545 | xargs kill -9`)
2. Starts Anvil fork:
   ```bash
   anvil --fork-url https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY \
         --chain-id 1337 \
         --port 8545
   ```
3. Waits for RPC readiness (polls `eth_blockNumber`)
4. Runs `deploy-and-seed.sh`:
   - Deploys all contracts via Forge script
   - Seeds test projects, vaults, messages
   - Funds test accounts (including your wallet with 10,000 ETH)
   - Writes addresses to `src/config/contracts.local.json`
5. Prints deployment summary with addresses

**Terminal 2 - Start Frontend:**
```bash
npm run dev
# Runs: node server.js (unchanged)
```

**Usage:**
- Open `http://localhost:3000`
- Frontend auto-detects local mode, connects to Anvil
- Chain stays running, restart frontend as needed
- Each `npm run chain:start` = full reset (fresh state)

---

## Network Detection & Configuration

### Network Detection Logic

**File:** `src/config/network.js`

```javascript
export function detectNetwork() {
  const hostname = window.location.hostname;
  const searchParams = new URLSearchParams(window.location.search);

  // Manual override via ?network=mock
  if (searchParams.get('network') === 'mock') {
    return {
      mode: 'mock',
      rpcUrl: null,
      contracts: null
    };
  }

  // Local development
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return {
      mode: 'local',
      rpcUrl: 'http://127.0.0.1:8545',
      chainId: 1337,
      contracts: '/src/config/contracts.local.json',
      abiPath: 'contracts/out' // Read from Forge artifacts
    };
  }

  // Production mainnet
  return {
    mode: 'mainnet',
    rpcUrl: 'https://ethereum.publicnode.com',
    chainId: 1,
    contracts: '/src/config/contracts.mainnet.json',
    abiPath: 'contracts/abi' // Exported ABIs
  };
}
```

**Behavior:**
- `localhost:3000` â†’ Anvil (chain ID 1337)
- `ms2.fun` â†’ Mainnet (chain ID 1)
- `localhost:3000?network=mock` â†’ Mock data (no chain)

### Hybrid ABI Loading

**File:** `src/utils/abiLoader.js`

```javascript
import { detectNetwork } from '../config/network.js';

export async function loadABI(contractName) {
  const network = detectNetwork();

  if (network.mode === 'local') {
    // Read directly from Forge build output
    const path = `/contracts/out/${contractName}.sol/${contractName}.json`;
    const response = await fetch(path);
    const artifact = await response.json();
    return artifact.abi;
  } else {
    // Read exported ABI (production)
    const path = `/contracts/abi/${contractName}.json`;
    const response = await fetch(path);
    return await response.json();
  }
}
```

**Benefits:**
- **Local dev:** No ABI export needed, always uses fresh Forge output
- **Production:** Clean exported ABIs only (no build artifacts)
- Fast iteration during development
- No manual ABI management

---

## Contract Address Management

### Auto-Generated Local Config

**File:** `src/config/contracts.local.json` (auto-generated after deployment)

```json
{
  "generatedAt": "2026-01-08T12:34:56Z",
  "chainId": 1337,
  "mode": "local-fork",
  "contracts": {
    "MasterRegistryV1": "0x5FbDB2315678afecb367f032d93F642f64180aa3",
    "GlobalMessageRegistry": "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512",
    "FactoryApprovalGovernance": "0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0",
    "VaultApprovalGovernance": "0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9",
    "ERC404Factory": "0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9",
    "ERC1155Factory": "0x5FC8d32690cc91D4c39d9d3abcBD16989F875707"
  },
  "instances": {
    "erc404": [
      {
        "name": "Early Launch",
        "address": "0x0165878A594ca255338adfa4d48449f69242Eb8F",
        "vault": "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0",
        "creator": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        "state": "early-bonding"
      },
      {
        "name": "Active Project",
        "address": "0xa513E6E4b8f2a923D98304ec87F64353C4D5C853",
        "vault": "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0",
        "creator": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        "state": "active-bonding"
      },
      {
        "name": "Graduated",
        "address": "0x2279B7A0a67DB372996a5FaB50D91eAA73d2eBe6",
        "vault": "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0",
        "creator": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        "state": "deployed"
      }
    ],
    "erc1155": [
      {
        "name": "Fixed Price Gallery",
        "address": "0x8A791620dd6260079BF849Dc5567aDC3F2FdC318",
        "vault": "0x0DCd1Bf9A1b36cE34237eEaFef220932846BCD82",
        "creator": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        "pricingModel": "fixed"
      },
      {
        "name": "Dynamic Pricing",
        "address": "0x610178dA211FEF7D417bC0e6FeD39F05609AD788",
        "vault": "0x0DCd1Bf9A1b36cE34237eEaFef220932846BCD82",
        "creator": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        "pricingModel": "dynamic"
      },
      {
        "name": "Mixed Supply",
        "address": "0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e",
        "vault": "0x0DCd1Bf9A1b36cE34237eEaFef220932846BCD82",
        "creator": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
        "pricingModel": "mixed"
      }
    ]
  },
  "vaults": [
    {
      "name": "ActiveVault",
      "address": "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0",
      "benefactors": 3,
      "accumulatedFees": "5000000000000000000"
    },
    {
      "name": "SimpleVault",
      "address": "0x0DCd1Bf9A1b36cE34237eEaFef220932846BCD82",
      "benefactors": 1,
      "accumulatedFees": "1000000000000000000"
    }
  ],
  "testAccounts": {
    "owner": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
    "trader": "0x70997970C51812dc3A010C7d01b50e0d17dc79C8",
    "collector": "0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC",
    "governance": "0x90F79bf6EB2c4f870365E785982E1f101E93b906"
  }
}
```

**Usage in Adapters:**

```javascript
// ProjectService.js or adapter initialization
import { detectNetwork } from '../config/network.js';

const network = detectNetwork();
const config = await fetch(network.contracts).then(r => r.json());

// Create adapter with local address
const registry = new MasterRegistryAdapter(
  config.contracts.MasterRegistryV1,
  'MasterRegistryV1',
  provider,
  signer
);
```

**Notes:**
- Config regenerated on every `chain:start`
- Addresses change if deployment order changes
- Will expand to include hooks, additional metadata as needed
- Mainnet config (`contracts.mainnet.json`) hand-maintained separately

---

## Seed Data Specification

### Phase 1: Representative Data (Initial Implementation)

**Core Infrastructure:**
- MasterRegistryV1
- GlobalMessageRegistry
- FactoryApprovalGovernance
- VaultApprovalGovernance
- ERC404Factory
- ERC1155Factory

**Vaults (2):**

1. **ActiveVault**
   - 3 benefactors with different contribution amounts
   - 5 ETH accumulated fees
   - Mix of instance types using it

2. **SimpleVault**
   - 1 benefactor (owner account)
   - 1 ETH fees
   - Used by ERC1155 instances

**ERC404 Instances (3):**

1. **"Early Launch"**
   - State: Early bonding curve (10% progress)
   - Tiers: Only tier 1 unlocked
   - Holders: 5 addresses with small amounts
   - Messages: 3-5 buy transactions
   - Vault: ActiveVault

2. **"Active Project"**
   - State: Mid bonding curve (60% progress)
   - Tiers: 3 tiers unlocked (password-protected demonstrated)
   - Holders: 20 addresses, varied amounts
   - Messages: 15 buy/sell transactions
   - Vault: ActiveVault
   - Features: Reroll enabled, some NFTs minted

3. **"Graduated"**
   - State: Liquidity deployed to Uniswap V4
   - Holders: 50 addresses
   - Messages: 10 post-deployment trades
   - Vault: ActiveVault
   - Features: Staking enabled, LP position active

**ERC1155 Instances (3):**

1. **"Fixed Price Gallery"**
   - 3 editions, all 0.01 ETH fixed price
   - Edition 1: 30 mints (unlimited supply)
   - Edition 2: 20 mints (unlimited supply)
   - Edition 3: 25 mints (unlimited supply)
   - Vault: SimpleVault
   - Messages: 8-10 mint transactions

2. **"Dynamic Pricing"**
   - 2 editions with linear price increase model
   - Edition 1: Base 0.005 ETH, +0.001 per mint, 10 mints
   - Edition 2: Base 0.01 ETH, +0.002 per mint, 8 mints
   - Vault: SimpleVault
   - Messages: 5-7 mint transactions showing price changes

3. **"Mixed Supply"**
   - Edition 1: Limited (100 max supply), 0.02 ETH, 45 minted
   - Edition 2: Unlimited, 0.005 ETH, 60 minted
   - Vault: SimpleVault
   - Messages: 8 mint transactions

**Test Accounts:**

| Account | Address | ETH Balance | EXEC Tokens | Purpose |
|---------|---------|-------------|-------------|---------|
| Your Wallet | (User's actual address) | 10,000 ETH | 0 | Development testing |
| Owner | 0xf39Fd... | 100 ETH | 0 | Created all instances |
| Trader | 0x70997... | 50 ETH | 0 | Bought ERC404 tokens |
| Collector | 0x3C44C... | 50 ETH | 0 | Minted ERC1155s |
| Governance | 0x90F79... | 100 ETH | 1000 EXEC | Voting participant |

**Global Activity Feed:**
- 15-20 messages total from all instances
- Mix of: buy, sell, mint, deploy, stake events
- Chronological order (newest first)
- Demonstrates message filtering by instance

### Phase 2: Full Showcase (Future Expansion)

Expand to demonstrate every protocol feature combination:

**Additional ERC404 States:**
- Bonding curve at 0%, 25%, 50%, 75%, 99%, 100%
- All tier unlock types: volume cap, time-based, password-protected
- Multiple reroll configurations
- Staking enabled vs disabled
- Different liquidity pool types
- Various curve parameters (linear, exponential, etc.)

**Additional ERC1155 Configurations:**
- All pricing models: fixed, linear, exponential, stepped
- Supply constraints: unlimited, capped, sold out
- Multiple editions per instance (5-10 editions)
- Different royalty configurations

**Additional Vaults:**
- Many benefactors (10+)
- Single benefactor
- High TVL vs low TVL
- Active conversion vs pending

**Governance States:**
- Active factory application
- Passed factory approval
- Failed factory approval
- Active challenge
- Vault approval flows

**Edge Cases:**
- Sold out editions
- Paused instances
- Failed transactions
- Zero-balance accounts interacting

---

## Wallet Integration

### MetaMask Setup (One-Time)

**Add Anvil Network to MetaMask:**

1. Open MetaMask â†’ Networks â†’ Add Network
2. Enter details:
   - **Network Name:** Anvil Local Fork
   - **RPC URL:** `http://127.0.0.1:8545`
   - **Chain ID:** `1337`
   - **Currency Symbol:** ETH

3. Import test account (optional):
   - Anvil provides deterministic private keys
   - Default account #0: `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`
   - Or use your existing wallet (script will fund it)

### Automatic Network Switching

```javascript
// WalletService.js
const network = detectNetwork();

if (network.mode === 'local') {
  // Prompt switch to Anvil if not already there
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: '0x539' }], // 1337 in hex
    });
  } catch (error) {
    if (error.code === 4902) {
      // Network not added, prompt to add it
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [{
          chainId: '0x539',
          chainName: 'Anvil Local Fork',
          rpcUrls: ['http://127.0.0.1:8545'],
          nativeCurrency: {
            name: 'Ether',
            symbol: 'ETH',
            decimals: 18
          }
        }]
      });
    }
  }
}
```

**Benefits:**
- Sign real transactions on local fork
- Test full user flow with MetaMask
- See actual gas costs and transaction confirmations
- Debug revert reasons with real error messages
- State persists during session (until chain restart)

---

## NPM Scripts

**package.json additions:**

```json
{
  "scripts": {
    "start": "node server.js",
    "dev": "node server.js",
    "setup:local": "bash scripts/local-chain/setup.sh",
    "chain:start": "bash scripts/local-chain/start-chain.sh",
    "chain:reset": "npm run chain:start",
    "contracts:build": "cd contracts && forge build",
    "contracts:update": "git submodule update --remote contracts && npm run contracts:build"
  }
}
```

**Script Descriptions:**

- `npm run setup:local` - One-time setup (init submodule, build contracts)
- `npm run chain:start` - Start Anvil, deploy contracts, seed data
- `npm run chain:reset` - Alias for chain:start (full reset)
- `npm run dev` - Start frontend server (unchanged)
- `npm run contracts:build` - Rebuild contracts without restarting chain
- `npm run contracts:update` - Pull latest contracts from submodule, rebuild

---

## Error Handling & Developer Experience

### Chain Startup Output

```bash
$ npm run chain:start

ğŸ”§ Checking for existing Anvil process...
  âœ“ Killed process on port 8545

ğŸš€ Starting Anvil fork from mainnet...
  Fork URL: https://eth-mainnet.g.alchemy.com/v2/***
  Chain ID: 1337
  Port: 8545
  âœ“ Anvil running (PID: 12345)

ğŸ“œ Deploying contracts to local fork...
  âœ“ MasterRegistryV1 â†’ 0x5FbDB2315678afecb367f032d93F642f64180aa3
  âœ“ GlobalMessageRegistry â†’ 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
  âœ“ FactoryApprovalGovernance â†’ 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
  âœ“ VaultApprovalGovernance â†’ 0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
  âœ“ ERC404Factory â†’ 0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9
  âœ“ ERC1155Factory â†’ 0x5FC8d32690cc91D4c39d9d3abcBD16989F875707

ğŸŒ± Seeding test data...
  âœ“ 2 vaults created (ActiveVault, SimpleVault)
  âœ“ 3 ERC404 instances deployed
     - Early Launch (10% bonding progress)
     - Active Project (60% bonding progress)
     - Graduated (liquidity deployed)
  âœ“ 3 ERC1155 instances deployed
     - Fixed Price Gallery (3 editions)
     - Dynamic Pricing (2 editions)
     - Mixed Supply (2 editions)
  âœ“ 20 messages posted to GlobalMessageRegistry

ğŸ’° Test accounts funded:
  Your Wallet    : 10,000 ETH
  Owner          : 100 ETH    (0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266)
  Trader         : 50 ETH     (0x70997970C51812dc3A010C7d01b50e0d17dc79C8)
  Collector      : 50 ETH     (0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC)
  Governance     : 100 ETH    (0x90F79bf6EB2c4f870365E785982E1f101E93b906)
                   1,000 EXEC

âœ… Local chain ready at http://127.0.0.1:8545
ğŸ“„ Contract addresses: src/config/contracts.local.json

ğŸ¯ Next step: npm run dev
```

### Error Handling

**Missing Foundry:**
```
âŒ Foundry not found!

Install Foundry:
  curl -L https://foundry.paradigm.xyz | bash
  foundryup

Then run: npm run setup:local
```

**Port 8545 Busy:**
```
âš ï¸  Port 8545 is busy and couldn't be killed automatically.

Manual fix:
  lsof -ti:8545 | xargs kill -9

Or check if another Anvil is running:
  ps aux | grep anvil
```

**Deployment Failed:**
```
âŒ Contract deployment failed!

Error: [Forge error message]

Possible causes:
  - Contract compilation errors
  - Insufficient gas
  - Network connection issues

Check contracts/script/DeployLocal.s.sol
Run: cd contracts && forge build
```

**Submodule Not Initialized:**
```
âŒ Contracts submodule not found!

Run: npm run setup:local

Or manually:
  git submodule update --init --recursive
  cd contracts && forge build
```

---

## Implementation Phases

### Phase 1: Foundation âœ… **Start Here**

**Goal:** Basic infrastructure working - can start Anvil, deploy contracts, get addresses

**Tasks:**
1. Add contracts repo as git submodule
2. Create directory structure:
   - `scripts/local-chain/`
   - `src/config/`
3. Create shell scripts:
   - `setup.sh` - Initialize submodule, build contracts
   - `start-chain.sh` - Kill port 8545, start Anvil fork
   - `deploy-and-seed.sh` - Run Forge script, write config
4. Add npm scripts to package.json
5. Create basic `DeployLocal.s.sol`:
   - Deploy core contracts only
   - Write addresses to `contracts.local.json`
   - No seeding yet (just deployments)
6. Update `src/config/network.js` for detection
7. Update `src/utils/abiLoader.js` for hybrid loading
8. Update adapter initialization to read from config

**Success Criteria:**
- âœ… Run `npm run chain:start` successfully
- âœ… Anvil running on port 8545
- âœ… All core contracts deployed
- âœ… `contracts.local.json` generated with addresses
- âœ… Can run `npm run dev` and connect to Anvil
- âœ… Adapters can read ABIs from `contracts/out/`

### Phase 2: Seed Data (Representative)

**Goal:** Populate chain with representative test data

**Tasks:**
1. Expand `DeployLocal.s.sol` with seeding logic:
   - Deploy 2 vaults (ActiveVault, SimpleVault)
   - Deploy 3 ERC404 instances in different states
   - Deploy 3 ERC1155 instances with different configs
   - Fund test accounts (owner, trader, collector, governance)
   - Fund user's wallet with 10,000 ETH
   - Mint EXEC tokens to governance account
   - Post 15-20 messages to GlobalMessageRegistry
2. Update `contracts.local.json` schema:
   - Add instances array with metadata
   - Add vaults array
   - Add testAccounts object
3. Add user interaction seeding:
   - Simulate buys/sells on ERC404s
   - Simulate mints on ERC1155s
   - Create holdings for test accounts

**Success Criteria:**
- âœ… Browse to localhost:3000
- âœ… See 3 ERC404 instances in different states
- âœ… See 3 ERC1155 instances with different pricing
- âœ… Activity feed shows 20 messages
- âœ… Can connect wallet and interact with instances
- âœ… Test accounts have expected balances

### Phase 3: Full Showcase (Future)

**Goal:** Every protocol feature combination represented

**Tasks:**
1. Expand seed data to include:
   - 10+ ERC404 instances covering all curve states
   - 10+ ERC1155 instances covering all pricing models
   - 5+ vaults in various states
   - Governance applications (pending, approved, rejected)
   - Edge cases (sold out, paused, failed txs)
2. Add documentation per instance:
   - What each instance demonstrates
   - Expected UI behavior
   - Test scenarios
3. Create instance categories in config:
   - Group by feature type
   - Tag with test scenarios

**Success Criteria:**
- âœ… Every checklist feature visible on localhost
- âœ… Edge cases testable
- âœ… Documented test scenarios

### Phase 4: Polish & Team Onboarding

**Goal:** Production-ready developer experience

**Tasks:**
1. Improve error messages and diagnostics
2. Add health checks:
   - Is Anvil running?
   - Are contracts deployed?
   - Is config file valid?
3. Add utility commands:
   - `npm run chain:status` - Check health
   - `npm run chain:accounts` - List test accounts
   - `npm run chain:reset` - Alias for restart
4. Write team documentation:
   - Setup guide for new developers
   - Troubleshooting common issues
   - How to update contracts
5. CI/CD integration:
   - GitHub Actions workflow
   - Automated testing on local fork

**Success Criteria:**
- âœ… New team member onboarding in <10 minutes
- âœ… Clear error messages for all failure modes
- âœ… Automated tests run on local fork in CI
- âœ… Documentation comprehensive

---

## Migration Strategy

### Preserving Existing Mock System

**No breaking changes to current development workflow:**

1. **Keep mock data system intact:**
   - `src/services/mock/mockData.js` stays
   - Mock contracts still work
   - `?network=mock` URL parameter activates mocks

2. **Gradual migration path:**
   - Phase 1: Local chain available as opt-in
   - Phase 2: Local chain becomes default for `npm run dev`
   - Phase 3: Mocks become fallback only
   - Phase 4: Mocks only via `?network=mock`

3. **Backward compatibility:**
   - All adapters support both mock and real contracts
   - Network detection handles all modes
   - No changes to component code initially

### Developer Choice

Developers can choose their environment:

```bash
# Option 1: Local Anvil fork (real contracts)
npm run chain:start   # Terminal 1
npm run dev          # Terminal 2
# â†’ localhost:3000 uses Anvil

# Option 2: Mock data (no chain needed)
npm run dev
# â†’ localhost:3000?network=mock uses mocks

# Option 3: Mainnet (production)
# â†’ Deploy to ms2.fun, uses mainnet
```

---

## Technical Considerations

### Anvil Fork Limitations

**What works:**
- âœ… Fork entire mainnet state
- âœ… Impersonate any address
- âœ… Deploy new contracts
- âœ… Fast block times (instant finality)
- âœ… State manipulation (set balances, etc.)

**What doesn't:**
- âŒ Historical event queries beyond fork block
- âŒ Some mainnet contracts may behave differently
- âŒ Mempool mechanics (everything instant)

**Workarounds:**
- Fork from recent block for latest state
- Use archive node RPC for historical data if needed
- Document any behavioral differences

### Performance Considerations

**Chain startup time:**
- Anvil fork: ~2-3 seconds
- Contract deployment: ~5-10 seconds
- Seeding: ~10-20 seconds (depends on data volume)
- **Total:** ~20-30 seconds for full setup

**Optimization opportunities:**
- Cache fork state to disk (`anvil --state-interval 1`)
- Parallel contract deployments where possible
- Batch seed transactions
- Skip seeding during rapid iteration (deploy only)

### Disk Space

**Estimated usage:**
- Contracts submodule: ~10-50 MB
- Forge cache: ~100-500 MB
- Anvil state (if persisted): ~1-5 GB (grows over time)

**Cleanup:**
- `forge clean` - Remove build cache
- Kill Anvil - State discarded (unless persisted)
- Submodule is shallow clone by default

---

## Security Considerations

### Test Account Private Keys

**Anvil default accounts:**
- Deterministic and PUBLIC
- NEVER use on mainnet
- Only for local development

**Private keys in config:**
- Do NOT commit private keys to git
- Use environment variables for sensitive keys
- `.gitignore` any files with real keys

### RPC URL Protection

**Alchemy/Infura keys:**
- Store in `.env` file (gitignored)
- Use `process.env.ALCHEMY_KEY` in scripts
- Never commit API keys to repository

**Example `.env`:**
```bash
ALCHEMY_API_KEY=your_key_here
FORK_URL=https://eth-mainnet.g.alchemy.com/v2/${ALCHEMY_API_KEY}
```

### Wallet Safety

**Development wallets:**
- Use separate wallet for local testing
- Burner wallet for seeding (funded by script)
- Main wallet only for production

---

## Future Enhancements

### Potential Additions

1. **State Snapshots:**
   - Save/restore Anvil state
   - Named snapshots (e.g., "before-governance-vote")
   - Quick reset to specific scenarios

2. **UI Devtools:**
   - Panel showing current chain state
   - Quick actions (fund account, mint tokens)
   - Transaction history viewer

3. **Multi-Chain Support:**
   - Fork Base, Arbitrum, etc.
   - Switch chains via UI
   - Cross-chain testing

4. **Automated Testing:**
   - E2E tests on local fork
   - Contract upgrade testing
   - Regression test suite

5. **Time Manipulation:**
   - Fast-forward time for tier unlocks
   - Test time-based features
   - Anvil supports `evm_increaseTime`

---

## Success Metrics

**Phase 1 Complete When:**
- âœ… Team member can run `npm run chain:start` successfully
- âœ… Contracts deploy without errors
- âœ… Config file generated correctly
- âœ… Frontend connects to local Anvil

**Phase 2 Complete When:**
- âœ… All 6 instances visible in UI
- âœ… Activity feed populated with messages
- âœ… Can buy ERC404 tokens on local chain
- âœ… Can mint ERC1155s on local chain
- âœ… Wallet integration works end-to-end

**Phase 3 Complete When:**
- âœ… Every checklist item testable locally
- âœ… All edge cases have test instances
- âœ… Documentation explains each instance

**Phase 4 Complete When:**
- âœ… New developer onboarded in <10 min
- âœ… CI/CD running local fork tests
- âœ… Zero manual configuration needed

---

## Appendix

### Useful Commands

**Git Submodule Management:**
```bash
# Initialize submodule (first time)
git submodule add <repo-url> contracts

# Update submodule to latest
git submodule update --remote contracts

# Clone repo with submodules
git clone --recursive <repo-url>

# If already cloned, init submodules
git submodule update --init --recursive

# Check submodule status
git submodule status

# Commit submodule reference update
git add contracts
git commit -m "chore: Update contracts submodule to v1.2.3"
```

**Anvil Commands:**
```bash
# Start fork with specific block
anvil --fork-url $RPC_URL --fork-block-number 12345678

# Start with state persistence
anvil --fork-url $RPC_URL --state state.json --state-interval 1

# Start with custom gas price
anvil --fork-url $RPC_URL --gas-price 0

# Impersonate address
cast rpc anvil_impersonateAccount 0x123...
```

**Forge Commands:**
```bash
# Deploy script
forge script script/DeployLocal.s.sol --rpc-url http://127.0.0.1:8545 --broadcast

# Build contracts
forge build

# Clean cache
forge clean

# Run tests on fork
forge test --fork-url http://127.0.0.1:8545
```

### Reference Links

- **Foundry Book:** https://book.getfoundry.sh/
- **Anvil Documentation:** https://book.getfoundry.sh/anvil/
- **Forge Scripting:** https://book.getfoundry.sh/tutorials/solidity-scripting
- **Git Submodules:** https://git-scm.com/book/en/v2/Git-Tools-Submodules

---

## Conclusion

This local development system provides a complete, version-controlled environment for building and testing the ms2.fun protocol. By integrating the contracts repo as a submodule and leveraging Anvil's mainnet fork capabilities, developers get:

- Real contract interactions without deploying to testnet
- Reproducible test data showcasing all features
- Fast iteration cycles with automatic configuration
- Production-like environment for debugging

The phased implementation ensures a smooth migration from the current mock system to a full local blockchain development workflow.

**Next Steps:**
1. Review this design with team
2. Begin Phase 1 implementation (foundation)
3. Test with team members
4. Iterate based on feedback
5. Expand to Phase 2 (seeding)

---

**Document Status:** âœ… Approved for Implementation
**Implementation Start:** Phase 1
**Owner:** Development Team
